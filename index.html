<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SRhythm</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .game-container {
        text-align: center;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
      }
      #score {
        font-size: 24px;
      }
      #lives {
        font-size: 18px;
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>Song Guess Game</h1>
      <button id="loginBtn">Sign in</button>
      <div id="game" style="display: none">
        <h2>Select Playlist</h2>
        <select id="playlistDropdown"></select
        ><br /><br />
        <button id="startGameBtn">Start Game</button>
      </div>
      <div id="inGame" style="display: none">
        <h2>Guess the Song</h2>
        <audio id="audioPlayer" controls></audio>
        <select id="songDropdown"></select
        ><br /><br />
        <button id="submitGuessBtn">Submit Guess</button>
        <p id="score">Score: 0</p>
        <p id="lives">Lives: 3</p>
      </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
      let accessToken;
      let currentPlaylist;
      let currentSong;
      let score = 0;
      let lives = 3;

      // Redirect to Spotify if access token is not available
      if (!accessToken) {
        window.location.href =
          "https://accounts.spotify.com/authorize?client_id=518660d4be8a4f60a36e270afefa1d6d&response_type=token&redirect_uri=https://akashsaran.github.io/SRhythm/&scope=playlist-read-private";
      }

      document
        .getElementById("loginBtn")
        .addEventListener("click", loginToSpotify);
      document
        .getElementById("startGameBtn")
        .addEventListener("click", startGame);
      document
        .getElementById("submitGuessBtn")
        .addEventListener("click", checkGuess);

      function loginToSpotify() {
        window.location.href =
          "https://accounts.spotify.com/authorize?client_id=518660d4be8a4f60a36e270afefa1d6d&response_type=token&redirect_uri=https://akashsaran.github.io/SRhythm/&scope=playlist-read-private";
      }

      function startGame() {
        fetchPlaylists().then((playlists) => {
          const playlistDropdown = document.getElementById("playlistDropdown");
          playlists.forEach((playlist) => {
            const option = document.createElement("option");
            option.value = playlist.id;
            option.textContent = playlist.name;
            playlistDropdown.appendChild(option);
          });
          currentPlaylist = playlists[0]; // Select the first playlist by default
          document.getElementById("game").style.display = "none";
          document.getElementById("inGame").style.display = "block";
        });
      }

      function fetchPlaylists() {
        return fetch("https://api.spotify.com/v1/me/playlists", {
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            return data.items || [];
          });
      }

      function startNewSong() {
        fetch(
          `https://api.spotify.com/v1/playlists/${currentPlaylist.id}/tracks`,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          }
        )
          .then((response) => response.json())
          .then((data) => {
            const track =
              data.items[Math.floor(Math.random() * data.items.length)].track;
            currentSong = track;
            document.getElementById("audioPlayer").src = track.preview_url;
            document.getElementById("audioPlayer").play();
            updateSongDropdown(data.items.map((item) => item.track.name));
          });
      }

      function updateSongDropdown(songList) {
        const songDropdown = document.getElementById("songDropdown");
        songDropdown.innerHTML = "";
        songList.forEach((song) => {
          const option = document.createElement("option");
          option.textContent = song;
          songDropdown.appendChild(option);
        });
      }

      function checkGuess() {
        const selectedSong = document.getElementById("songDropdown").value;
        const songName = currentSong.name;

        if (selectedSong === songName) {
          updateScoreAndLives(true);
          startNewSong();
        } else {
          updateScoreAndLives(false);
        }
      }

      function updateScoreAndLives(isCorrect) {
        if (isCorrect) {
          score += 1000;
          document.getElementById("score").textContent = `Score: ${score}`;
        } else {
          lives -= 1;
          document.getElementById("lives").textContent = `Lives: ${lives}`;
          if (lives <= 0) {
            alert("Game over! Final Score: " + score);
            resetGame();
          }
        }
      }

      function resetGame() {
        lives = 3;
        score = 0;
        document.getElementById("score").textContent = `Score: ${score}`;
        document.getElementById("lives").textContent = `Lives: ${lives}`;
        document.getElementById("inGame").style.display = "none";
        document.getElementById("game").style.display = "block";
      }

      if (window.location.hash) {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        accessToken = params.get("access_token");
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("game").style.display = "block";
      }
    </script>
  </body>
</html>
